FROM node:20-alpine

# Install dependencies for audio and build tools
RUN apk add --no-cache \
    alsa-utils \
    alsa-lib \
    alsa-plugins \
    alsa-plugins-pulse \
    sox \
    python3 \
    make \
    g++ && \
    # Configure sox to use ALSA directly (not libao)
    echo "Configuring audio drivers..."

# Cr√©ation du r√©pertoire de l'application
WORKDIR /app

# Copie des fichiers package.json
COPY package*.json ./

# Installation des d√©pendances Node.js
RUN npm install

# Copie de tous les fichiers de l'application
COPY . .

# Cr√©ation des r√©pertoires de destination (vides, seront mont√©s via volume)
RUN mkdir -p /app/data /app/audio

# Copie des fichiers audio et data dans des dossiers "seed" pour initialisation
# IMPORTANT: Cette copie inclut TOUS les sous-dossiers: athan/, coran/, system/
RUN mkdir -p /app/audio_seed /app/data_seed && \
    echo "üìÇ Copying audio files to seed directory..." && \
    cp -rv audio/* /app/audio_seed/ && \
    echo "üìÇ Audio files copied. Contents:" && \
    ls -lR /app/audio_seed/ && \
    echo "üìÇ Copying data files to seed directory..." && \
    cp -rv data/* /app/data_seed/ 2>/dev/null || true && \
    echo "‚úÖ Seed directories created successfully"

# Rendre le script d'entrypoint ex√©cutable
RUN chmod +x /app/entrypoint.sh

# Exposition du port
EXPOSE 7777

# Utiliser l'entrypoint pour initialiser les volumes
ENTRYPOINT ["/app/entrypoint.sh"]

# Commande de d√©marrage
CMD ["node", "server.js"]
