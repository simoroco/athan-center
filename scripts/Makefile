# Makefile pour Athan Center
# Simplifie les commandes courantes

.PHONY: help quick install start stop restart logs build clean test setup deploy

# Afficher l'aide
help:
	@echo "ğŸ•Œ Athan Center - Commandes Disponibles"
	@echo "========================================"
	@echo ""
	@echo "  make quick      - âš¡ Lancement rapide (docker-compose up -d)"
	@echo "  make install    - Installer les dÃ©pendances"
	@echo "  make setup      - Installation automatique complÃ¨te"
	@echo "  make build      - Construire l'image Docker"
	@echo "  make start      - DÃ©marrer l'application"
	@echo "  make stop       - ArrÃªter l'application"
	@echo "  make restart    - RedÃ©marrer l'application"
	@echo "  make logs       - Afficher les logs"
	@echo "  make test       - Tester l'API"
	@echo "  make clean      - Nettoyer les fichiers gÃ©nÃ©rÃ©s"
	@echo "  make deploy     - DÃ©ployer en production"
	@echo "  make check      - VÃ©rifier la configuration"
	@echo ""

# Lancement rapide
quick:
	@echo "âš¡ Lancement rapide de Athan Center..."
	docker-compose up -d
	@echo "âœ“ Application dÃ©marrÃ©e!"
	@echo "ğŸ“± AccÃ¨s: http://localhost:7777"

# Installer les dÃ©pendances Node.js
install:
	@echo "ğŸ“¦ Installation des dÃ©pendances..."
	npm install
	@echo "âœ“ DÃ©pendances installÃ©es"

# Installation automatique complÃ¨te
setup:
	@echo "ğŸš€ Installation automatique..."
	chmod +x setup.sh
	./setup.sh

# Construire l'image Docker
build:
	@echo "ğŸ”¨ Construction de l'image Docker..."
	docker-compose build
	@echo "âœ“ Image construite"

# DÃ©marrer l'application
start:
	@echo "â–¶ï¸  DÃ©marrage de l'application..."
	docker-compose up -d
	@echo "âœ“ Application dÃ©marrÃ©e"
	@echo "ğŸ“± AccÃ¨s: http://localhost:7777"

# ArrÃªter l'application
stop:
	@echo "â¹ï¸  ArrÃªt de l'application..."
	docker-compose down
	@echo "âœ“ Application arrÃªtÃ©e"

# RedÃ©marrer l'application
restart:
	@echo "ğŸ”„ RedÃ©marrage de l'application..."
	docker-compose restart
	@echo "âœ“ Application redÃ©marrÃ©e"

# Afficher les logs
logs:
	@echo "ğŸ“‹ Logs de l'application..."
	docker-compose logs -f

# Tester l'API
test:
	@echo "ğŸ§ª Tests de l'API..."
	chmod +x test-api.sh
	./test-api.sh

# Nettoyer
clean:
	@echo "ğŸ§¹ Nettoyage..."
	docker-compose down -v
	rm -rf node_modules
	rm -f data/prayer.db
	@echo "âœ“ Nettoyage terminÃ©"

# DÃ©ployer en production
deploy: build
	@echo "ğŸš¢ DÃ©ploiement en production..."
	docker-compose up -d --build
	@echo "âœ“ DÃ©ploiement terminÃ©"
	@echo "ğŸ“± AccÃ¨s: http://localhost:7777"

# VÃ©rifier la configuration
check:
	@echo "âœ… VÃ©rification de la configuration..."
	@echo ""
	@echo "1. VÃ©rification Docker..."
	@command -v docker >/dev/null 2>&1 && echo "  âœ“ Docker installÃ©" || echo "  âœ— Docker manquant"
	@command -v docker-compose >/dev/null 2>&1 && echo "  âœ“ Docker Compose installÃ©" || echo "  âœ— Docker Compose manquant"
	@echo ""
	@echo "2. VÃ©rification des fichiers..."
	@test -f server.js && echo "  âœ“ server.js prÃ©sent" || echo "  âœ— server.js manquant"
	@test -f public/index.html && echo "  âœ“ index.html prÃ©sent" || echo "  âœ— index.html manquant"
	@test -f Dockerfile && echo "  âœ“ Dockerfile prÃ©sent" || echo "  âœ— Dockerfile manquant"
	@echo ""
	@echo "3. VÃ©rification des dossiers..."
	@test -d audio && echo "  âœ“ Dossier audio/ prÃ©sent" || echo "  âœ— Dossier audio/ manquant"
	@test -d data && echo "  âœ“ Dossier data/ prÃ©sent" || echo "  âœ— Dossier data/ manquant"
	@echo ""
	@echo "4. VÃ©rification audio..."
	@ls audio/*.mp3 >/dev/null 2>&1 && echo "  âœ“ Fichiers audio trouvÃ©s" || echo "  âš  Aucun fichier audio (ajoutez athan.mp3)"
	@echo ""

# Backup
backup:
	@echo "ğŸ’¾ Sauvegarde..."
	@mkdir -p backups
	@tar -czf backups/athan-center-backup-$$(date +%Y%m%d_%H%M%S).tar.gz data/ audio/
	@echo "âœ“ Sauvegarde crÃ©Ã©e dans backups/"

# Restore (utiliser: make restore FILE=backup.tar.gz)
restore:
	@echo "ğŸ“¥ Restauration..."
	@test -n "$(FILE)" || (echo "Erreur: SpÃ©cifiez FILE=backup.tar.gz" && exit 1)
	@tar -xzf $(FILE)
	@echo "âœ“ Restauration terminÃ©e"

# Dev - DÃ©marrer en mode dÃ©veloppement
dev:
	@echo "ğŸ”§ Mode dÃ©veloppement..."
	npm run dev

# Statistiques
stats:
	@echo "ğŸ“Š Statistiques Docker..."
	docker stats athan-center --no-stream

# Informations systÃ¨me
info:
	@echo "â„¹ï¸  Informations systÃ¨me..."
	@echo ""
	@echo "Docker version:"
	@docker --version
	@echo ""
	@echo "Docker Compose version:"
	@docker-compose --version
	@echo ""
	@echo "Node version:"
	@node --version 2>/dev/null || echo "Node non installÃ©"
	@echo ""
	@echo "Espace disque:"
	@df -h . | tail -1
	@echo ""

# Shell dans le conteneur
shell:
	@echo "ğŸš Ouverture du shell dans le conteneur..."
	docker exec -it athan-center /bin/bash

# Mise Ã  jour
update:
	@echo "â¬†ï¸  Mise Ã  jour..."
	git pull
	npm install
	docker-compose up -d --build
	@echo "âœ“ Mise Ã  jour terminÃ©e"
